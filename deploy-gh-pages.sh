#!/bin/bash

# Exit on error
set -e

echo "ðŸš€ Starting GitHub Pages deployment..."

# Check if we're in a git repository
if [ ! -d .git ]; then
    echo "âŒ Error: Not a git repository"
    exit 1
fi

# Check if there are uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "âš ï¸  Warning: You have uncommitted changes"
    read -p "Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Ensure we're on main branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo "âš ï¸  Warning: You're on branch '$CURRENT_BRANCH', not 'main'"
    read -p "Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Build the Wasm production bundle BEFORE switching branches
echo "ðŸ—ï¸  Building production bundle..."
./gradlew :composeApp:wasmJsBrowserDistribution --no-daemon

# Check if build was successful
BUILD_OUTPUT="composeApp/build/dist/wasmJs/productionExecutable"
if [ ! -d "$BUILD_OUTPUT" ]; then
    echo "âŒ Error: Build failed - output directory not found"
    exit 1
fi

# Copy build output to a temporary directory outside the repo
echo "ðŸ“¦ Copying build output to temp directory..."
TEMP_DIR=$(mktemp -d)
cp -r "$BUILD_OUTPUT"/* "$TEMP_DIR/"

# Check if gh-pages branch exists
if git show-ref --verify --quiet refs/heads/gh-pages; then
    echo "ðŸ“Œ Checking out existing gh-pages branch..."
    git checkout gh-pages
    # Fetch latest from remote if it exists
    git fetch origin gh-pages 2>/dev/null || true
    git reset --hard origin/gh-pages 2>/dev/null || true
else
    echo "ðŸŒ¿ Creating new gh-pages branch..."
    git checkout --orphan gh-pages
    git rm -rf . 2>/dev/null || true
fi

# Remove all files except .git
echo "ðŸ§¹ Cleaning branch..."
find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +

# Move build output from temp to root
echo "ðŸ“¦ Moving build output to root..."
cp -r "$TEMP_DIR"/* .

# Clean up temp directory
rm -rf "$TEMP_DIR"

# Add .nojekyll file (important for GitHub Pages)
echo "ðŸ“„ Creating .nojekyll file..."
touch .nojekyll

# Create a simple README for gh-pages branch
cat > README.md << 'EOF'
# GitHub Pages Deployment

This branch contains the compiled WebAssembly application for GitHub Pages.

**Do not edit this branch manually!** It is automatically generated by the deployment script.

To update the deployment, run `./deploy-gh-pages.sh` from the `main` branch.
EOF

# Stage all changes
echo "ðŸ“ Staging changes..."
git add -A

# Commit
echo "ðŸ’¾ Committing..."
git commit -m "Deploy to GitHub Pages - $(date '+%Y-%m-%d %H:%M:%S')"

# Push to remote
echo "â¬†ï¸  Pushing to remote..."
git push origin gh-pages

# Switch back to main branch
echo "ðŸ”„ Switching back to main branch..."
git checkout main

echo "âœ… Deployment complete!"
echo "ðŸŒ Your site should be available at: https://<username>.github.io/<repository>/"
echo "ðŸ“‹ Make sure to configure GitHub Pages in repository settings to use the 'gh-pages' branch."